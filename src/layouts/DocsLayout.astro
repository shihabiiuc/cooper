---
import UntranslatedLayout from './UntranslatedLayout.astro';
import { getCollection } from 'astro:content';
import { clsx } from 'clsx';
import TableOfContents from '~/components/blog/TableOfContents.astro';
import type { MarkdownHeading } from 'astro';
import { defaultLang } from '~/i18n/ui';
import { useTranslations } from '~/i18n/utils';
import ScrollProgress from '~/components/layout/ScrollProgress.astro';
import MobileDocsMenu from '~/components/islands/MobileDocsMenu';

interface Props {
  title: string;
  description: string;
  noindex?: boolean;
  nofollow?: boolean;
  headings?: MarkdownHeading[];
}

const { title, description, noindex, nofollow, headings = [] } = Astro.props;

const docs = (await getCollection('docs')).sort((a, b) => (a.data.order ?? 99) - (b.data.order ?? 99));

// Helper to get clean slug from ID
const getSlug = (id: string) => id.replace(/\.[^/.]+$/, "");

// Group docs by folder
const groupedDocs = docs.reduce((acc, doc) => {
  const slug = getSlug(doc.id);
  const parts = slug.split('/');
  const section = parts.length > 1 ? parts[0] : 'root';
  const key = section as string;
  if (!acc[key]) acc[key] = [];
  acc[key].push(doc);
  return acc;
}, {} as Record<string, typeof docs>);

// Sort sections: root first, then by defined order, then alphabetical
const SECTION_ORDER = ['root', 'theming', 'ui', 'layout', 'sections', 'blog-docs', 'seo'];
const sections = Object.keys(groupedDocs).sort((a, b) => {
  const indexA = SECTION_ORDER.indexOf(a);
  const indexB = SECTION_ORDER.indexOf(b);
  
  if (indexA !== -1 && indexB !== -1) return indexA - indexB;
  if (indexA !== -1) return -1;
  if (indexB !== -1) return 1;
  return a.localeCompare(b);
});

// Flatten docs for next/prev navigation
const flattenedDocs = sections.flatMap(section => groupedDocs[section]);
const currentPath = Astro.url.pathname;
const normalizedCurrentPath = currentPath.endsWith('/') && currentPath.length > 1 ? currentPath.slice(0, -1) : currentPath;

const currentIndex = flattenedDocs.findIndex(doc => {
    const docPath = `/docs/${getSlug(doc.id)}`;
    return normalizedCurrentPath === docPath || normalizedCurrentPath === `/docs/${getSlug(doc.id)}`;
});

const prevDoc = currentIndex > 0 ? flattenedDocs[currentIndex - 1] : null;
const nextDoc = currentIndex < flattenedDocs.length - 1 ? flattenedDocs[currentIndex + 1] : null;

// Custom styles for specific sections
const SECTION_CUSTOMIZATION: Record<string, { icon: string, color: string, label?: string }> = {
  'theming': { icon: 'üé®', color: 'text-pink-500', label: 'Theming' },
  'ui': { icon: 'üß©', color: 'text-blue-500', label: 'UI Components' },
  'layout': { icon: 'üèóÔ∏è', color: 'text-indigo-500', label: 'Layout' },
  'sections': { icon: 'üß±', color: 'text-purple-500', label: 'Sections' },
  'blog-docs': { icon: 'üì∞', color: 'text-orange-500', label: 'Blog Components' },
  'seo': { icon: 'üîç', color: 'text-purple-500', label: 'SEO' },
};

---

<UntranslatedLayout title={title} description={description} noindex={noindex} nofollow={nofollow}>
  <ScrollProgress />
  <div class="max-w-360 mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex w-full lg:grid lg:grid-cols-[280px_1fr_240px] gap-10 pt-32 pb-24">
        
        {/* Sidebar Navigation */}
        <aside class="hidden lg:block fixed inset-y-0 left-0 z-20 w-72 overflow-y-auto border-r border-foreground/5 bg-background px-6 pb-4 pt-32 lg:static lg:w-auto lg:border-r-0 lg:bg-transparent lg:px-0 lg:pb-0 lg:pt-0">
             <div class="sticky top-24 space-y-8">
                 <nav class="space-y-1" aria-label="Documentation Sidebar">
                    {sections.map((section) => {
                        const sectionDocs = groupedDocs[section];
                        
                        if (section === 'root') {
                            return (
                                <ul class="space-y-1 mb-8 list-none p-0">
                                    {sectionDocs.map(doc => {
                                        const docPath = `/docs/${getSlug(doc.id)}`;
                                        const isExact = normalizedCurrentPath === docPath;
                                        return (
                                            <li>
                                                <a
                                                    href={docPath}
                                                    class={clsx(
                                                        "group flex items-center gap-2 rounded-lg px-3 py-2 text-sm font-medium transition-all",
                                                        isExact 
                                                        ? "bg-primary/10 text-primary shadow-sm ring-1 ring-primary/20" 
                                                        : "text-foreground/70 hover:text-foreground hover:bg-foreground/5"
                                                    )}
                                                >
                                                    <span class={clsx("w-1.5 h-1.5 rounded-full transition-all", isExact ? "bg-primary scale-110" : "bg-foreground/20 group-hover:bg-foreground/40")}></span>
                                                    {doc.data.title}
                                                </a>
                                            </li>
                                        )
                                    })}
                                </ul>
                            );
                        }

                        const customization = SECTION_CUSTOMIZATION[section] || {};
                        const rawTitle = section.charAt(0).toUpperCase() + section.slice(1).replace(/-/g, ' ');
                        const sectionTitle = customization.label || rawTitle;
                        const sectionColor = customization.color || 'text-foreground/70';
                        const isOpen = sectionDocs.some(doc => normalizedCurrentPath === `/docs/${getSlug(doc.id)}`);
                        
                        return (
                            <details class="group/section" open={isOpen}>
                                <summary class="list-none cursor-pointer outline-none">
                                    <div class={clsx(
                                        "flex items-center justify-between px-3 py-2 text-sm font-semibold rounded-lg hover:bg-foreground/5 transition-colors group",
                                        sectionColor
                                    )}>
                                        <div class="flex items-center gap-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 opacity-70 group-hover:opacity-100 transition-opacity">
                                                <path d="m6 9 6 6 6-6"/>
                                            </svg>
                                            {customization.icon && <span class="text-base leading-none shrink-0">{customization.icon}</span>}
                                            <span class="tracking-wide">{sectionTitle}</span>
                                        </div>
                                        <span class="text-[10px] bg-foreground/5 px-1.5 py-0.5 rounded-full opacity-50 group-hover:opacity-100">{sectionDocs.length}</span>
                                    </div>
                                </summary>
                                <div class="mt-1 ml-4 pl-4 border-l border-foreground/10 space-y-1 relative">
                                    {/* Vertical guide line that looks like a tree branch */}
                                    <div class="absolute left-0 top-0 bottom-4 w-px bg-foreground/10"></div>
                                    
                                    <ul class="list-none p-0 m-0 space-y-1">
                                        {sectionDocs.map((doc, idx) => {
                                            const docPath = `/docs/${getSlug(doc.id)}`;
                                            const isExact = normalizedCurrentPath === docPath;
                                            return (
                                                <li class="relative">
                                                    {/* Horizontal branch marker */}
                                                    <div class="absolute -left-4 top-1/2 -translate-y-1/2 w-3 h-px bg-foreground/10"></div>
                                                    
                                                    <a
                                                        href={docPath}
                                                        class={clsx(
                                                            "group flex items-center gap-2 rounded-md px-3 py-1.5 text-sm transition-all",
                                                            isExact 
                                                            ? "bg-primary/5 text-primary font-semibold translate-x-1" 
                                                            : "text-foreground/60 hover:text-foreground hover:bg-foreground/5"
                                                        )}
                                                    >
                                                        {isExact && <div class="w-1 h-1 rounded-full bg-primary" />}
                                                        <span class="truncate">{doc.data.title}</span>
                                                    </a>
                                                </li>
                                            )
                                        })}
                                    </ul>
                                </div>
                            </details>
                        );
                    })}
                </nav>
             </div>
        </aside>

        {/* Main Content */}
        <main class="min-w-0 flex-1" data-pagefind-ignore>
             {/* Breadcrumbs & Mobile Menu */}
             <div class="mb-6 flex items-center justify-between gap-4">
                <div class="flex items-center gap-2 text-sm text-m  uted-foreground">
                    <a href="/docs" class="hover:text-foreground transition-colors">Docs</a>
                    <span class="text-foreground/20">/</span>
                    <span class="text-foreground">{title}</span>
                </div>
                
                <MobileDocsMenu 
                    client:load 
                    sections={sections} 
                    groupedDocs={groupedDocs} 
                    currentPath={Astro.url.pathname} 
                />
             </div>

            <div class="prose prose-lg max-w-none prose-headings:font-bold prose-headings:scroll-mt-24 prose-a:text-primary hover:prose-a:text-primary/80 dark:prose-invert text-foreground prose-headings:text-foreground prose-p:text-foreground/80 prose-strong:text-foreground prose-code:text-primary prose-pre:border prose-pre:border-white/10 prose-pre:bg-black/80">
                <h1 class="text-4xl font-bold mb-8 text-foreground">{title}</h1>
                <slot />
            </div>

            {/* Next/Prev Navigation */}
            <hr class="my-10 border-foreground/10" />
            <div class="flex flex-col sm:flex-row gap-4 justify-between">
                {prevDoc ? (
                    <a href={`/docs/${getSlug(prevDoc.id)}`} class="group flex flex-col gap-1 p-4 rounded-xl border border-foreground/10 hover:border-primary/30 hover:bg-primary/5 transition-all text-left">
                        <span class="text-xs text-muted-foreground font-medium group-hover:text-primary/70">Previous</span>
                        <span class="text-foreground font-bold group-hover:text-primary">{prevDoc.data.title}</span>
                    </a>
                ) : <div/>}

                 {nextDoc && (
                    <a href={`/docs/${getSlug(nextDoc.id)}`} class="group flex flex-col gap-1 p-4 rounded-xl border border-foreground/10 hover:border-primary/30 hover:bg-primary/5 transition-all text-right items-end">
                        <span class="text-xs text-muted-foreground font-medium group-hover:text-primary/70">Next</span>
                        <span class="text-foreground font-bold group-hover:text-primary">{nextDoc.data.title}</span>
                    </a>
                )}
            </div>
        </main>

        {/* Right Sidebar: Table of Contents */}
        <aside class="hidden xl:block min-w-[240px]">
            {headings.length > 0 && (
                <TableOfContents headings={headings} />
            )}
        </aside>

    </div>
  </div>
</UntranslatedLayout>

<style>
    /* Chevron rotation for tree folders */
    details summary svg {
        transition: transform 0.2s ease, opacity 0.2s ease;
        transform: rotate(-90deg);
    }
    details[open] summary svg {
        transform: rotate(0deg);
        opacity: 1;
    }
    
    /* Hover effect for branch guides */
    details summary:hover ~ div {
        border-left-color: var(--color-primary-alpha-20);
    }
</style>
