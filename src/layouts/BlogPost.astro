---
import Layout from './Layout.astro';
import { Image } from 'astro:assets';
import AudioPlayer from '~/components/common/AudioPlayer.astro';
import { defaultLang } from '~/i18n/ui';
import { isRtl, useTranslations } from '~/i18n/utils';

interface Props {
  title: string;
  description: string;
  pubDate: Date;
  updatedDate?: Date;
  heroImage?: ImageMetadata;
  youtubeId?: string;
  audioUrl?: string; // Add audioUrl prop
  isVideo?: boolean;
  children?: any;
  noindex?: boolean;
  nofollow?: boolean;
  availableLangs?: string[];
}

const { title, description, pubDate, updatedDate, heroImage, youtubeId, audioUrl, isVideo, noindex, nofollow, availableLangs } = Astro.props;
const { lang = defaultLang } = Astro.params;
const t = useTranslations(lang);

const schema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": title,
  "description": description,
  "datePublished": pubDate.toISOString(),
  ...(updatedDate && { "dateModified": updatedDate.toISOString() }),
  ...(heroImage && { "image": new URL(heroImage.src, Astro.site).toString() }),
  "author": {
      "@type": "Person",
      "name": "Cooper Team",
      "url": "https://cooper.example.com" // Replace with dynamic author if available
  }
};
import ScrollProgress from '~/components/layout/ScrollProgress.astro';
---

<script type="application/ld+json" set:html={JSON.stringify(schema)} slot="head"></script>

<Layout title={title} description={description} image={heroImage?.src} article={true} noindex={noindex} nofollow={nofollow} availableLangs={availableLangs}>
  <ScrollProgress />
  <article class="max-w-4xl mx-auto px-6 py-20">
    <div class="mb-8">
        <a href={`/${lang}/blog`} class="inline-flex items-center gap-2 text-sm text-muted-foreground hover:text-primary transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class={`w-4 h-4 ${isRtl(lang) ? 'rotate-180' : ''}`}><path d="m15 18-6-6 6-6"/></svg>
            {t['blog.back']}
        </a>
    </div>

    <div class="mb-12 text-center">
        {heroImage && !youtubeId && (
            <div class="rounded-2xl overflow-hidden mb-8 border border-black/10 dark:border-white/10 shadow-2xl">
                <Image src={heroImage} alt="" class="w-full object-cover aspect-video" />
            </div>
        )}

        {youtubeId && (
            <div class="rounded-2xl overflow-hidden mb-8 border border-black/10 dark:border-white/10 shadow-2xl aspect-video bg-black">
                <iframe 
                    width="100%" 
                    height="100%" 
                    src={`https://www.youtube.com/embed/${youtubeId}`} 
                    title="YouTube video player" 
                    frameborder="0" 
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                    allowfullscreen
                ></iframe>
            </div>
        )}

        {audioUrl && (
            <div class="mb-8 overflow-hidden rounded-xl shadow-lg border border-black/5 dark:border-white/10">
                <AudioPlayer src={audioUrl} title={title} />
            </div>
        )}
        
        <div class="flex items-center justify-center gap-4 text-muted-foreground mb-4">
            {isVideo && (
                <span class="px-2 py-0.5 text-[10px] font-bold uppercase tracking-widest rounded-md bg-red-500/10 text-red-500 border border-red-500/20">
                    {t['blog.videoContent']}
                </span>
            )}
            <time>{pubDate.toLocaleDateString(lang, { year: 'numeric', month: 'long', day: 'numeric'})}</time>
            {updatedDate && (
                <div class="italic">
                    ({t['blog.updatedOn']} {updatedDate.toLocaleDateString(lang, { year: 'numeric', month: 'long', day: 'numeric'})})
                </div>
            )}
        </div>

        <h1 class="text-4xl md:text-6xl font-display font-bold mb-6 bg-linear-to-br from-white to-white/60 bg-clip-text text-transparent">{title}</h1>
        <p class="text-xl text-muted-foreground max-w-2xl mx-auto">{description}</p>
        <hr class="border-black/10 dark:border-white/10 mt-8" />
    </div>

    <div class="prose prose-lg mx-auto prose-img:rounded-xl prose-headings:font-display prose-headings:font-bold prose-a:text-primary hover:prose-a:text-primary/80 dark:prose-invert">
      <slot />
    </div>
  </article>
</Layout>
