---
import Layout from '~/layouts/Layout.astro';
import PageHeader from '~/components/layout/PageHeader.astro';
import Button from '~/components/ui/Button.astro';
import BlogCard from '~/components/blog/BlogCard.astro';
import Container from '~/components/ui/Container.astro';
import Grid from '~/components/ui/Grid.astro';
import { getCollection } from 'astro:content';
import { siteConfig } from '~/site.config';

import { languages, defaultLang } from '~/i18n/ui';
import { useTranslations } from '~/i18n/utils';

import type { GetStaticPathsOptions, Page } from 'astro';
import type { CollectionEntry } from 'astro:content';

export async function getStaticPaths({ paginate }: { paginate: GetStaticPathsOptions['paginate'] }) {
  const posts = (await getCollection('blog')).sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
  );

  return Object.keys(languages).flatMap((lang) => {
      const filteredPosts = posts.filter((post) => post.id.startsWith(`${lang}/`));
      return paginate(filteredPosts, { 
          params: { lang }, 
          pageSize: siteConfig.blog.postsPerPage
      });
  });
}

const { page } = Astro.props as { page: Page<CollectionEntry<'blog'>> };
const { lang } = Astro.params;
const t = useTranslations(lang);
---

<Layout title="Blog - Astro Boilerplate" description="Read our latest articles">
  <PageHeader 
      title={t['blog.hero.title']}
      description={t['blog.hero.subtitle']}
  />

  <Container as="section" class="pb-24">
      <Grid cols={3} class="mb-16">
        {page.data.map((post: CollectionEntry<'blog'>) => (
          <BlogCard 
             title={post.data.title}
             description={post.data.description}
             pubDate={post.data.pubDate}
             heroImage={post.data.heroImage}
             slug={`/${lang}/blog/${post.id.split('/').slice(1).join('/').replace(/\.[^/.]+$/, "")}`}
             isVideo={post.data.isVideo}
          />
        ))}
      </Grid>
      
      <div class="flex items-center justify-center gap-4">
        {page.url.prev && (
            <Button href={page.url.prev} variant="outline" class="gap-2 px-6 py-3 rounded-full bg-white dark:bg-zinc-800">
                ← {t['blog.prev']}
            </Button>
        )}
        
        <span class="text-sm font-bold text-muted-foreground">
            {t['blog.page']} {page.currentPage} {t['blog.of']} {page.lastPage}
        </span>

        {page.url.next && (
            <Button href={page.url.next} variant="outline" class="gap-2 px-6 py-3 rounded-full bg-white dark:bg-zinc-800">
                {t['blog.next']} →
            </Button>
        )}
      </div>
  </Container>
</Layout>
