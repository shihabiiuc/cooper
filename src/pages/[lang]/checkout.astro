---
import Layout from '~/layouts/Layout.astro';
import { getLangFromUrl, useTranslations } from '~/i18n/utils';
import { Check, User, ArrowRight, CreditCard, Lock, Loader2 } from 'lucide-react';

export const prerender = false;

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const currentPlan = Astro.url.searchParams.get('plan') || '';
const planDisplay = currentPlan ? currentPlan.charAt(0).toUpperCase() + currentPlan.slice(1) : '';

const steps = [
    { number: 1, title: t['checkout.step.account'] },
    { number: 2, title: t['checkout.step.payment'] },
    { number: 3, title: t['checkout.step.success'] }
];
---

<Layout title={t['checkout.title']} description={t['checkout.description']}>
  <div class="min-h-[80vh] flex items-center justify-center px-6 py-20 relative overflow-hidden">
    {/* Background blobs */}
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[800px] h-[800px] bg-primary/20 rounded-full blur-[120px] -z-10"></div>

    <div class="w-full max-w-md mx-auto" id="checkout-container">
      {/* Progress Steps */}
      <div class="flex justify-between mb-12 relative">
          <div class="absolute top-1/2 left-0 w-full h-0.5 bg-black/10 dark:bg-white/10 -z-10 -translate-y-1/2"></div>
          {steps.map((s) => (
              <div class="step-indicator flex flex-col items-center gap-2 bg-background z-10 px-2" data-step={s.number}>
                  <div class="step-circle w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm transition-colors duration-300 border-2 bg-background border-black/10 dark:border-white/10 text-muted-foreground">
                      {s.number}
                  </div>
                  <span class="step-label text-xs font-medium text-muted-foreground">
                      {s.title}
                  </span>
              </div>
          ))}
      </div>

      <div class="bg-white/5 backdrop-blur-xl border border-black/10 dark:border-white/10 rounded-3xl p-8 shadow-2xl relative overflow-hidden">
        
        {/* Step 1: Account */}
        <div id="step-1" class="step-content transition-opacity duration-300">
          <h2 class="text-2xl font-bold font-display mb-2">{t['checkout.account.title']}</h2>
          <p class="text-muted-foreground mb-6">
             {planDisplay 
                ? t['checkout.account.subtitle.plan'].replace('{plan}', planDisplay) 
                : t['checkout.account.subtitle.default']
             }
          </p>
          
          <div class="space-y-4">
              <div>
                  <label class="block text-sm font-medium mb-1.5">{t['checkout.label.fullname']}</label>
                  <div class="relative">
                      <div class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground flex items-center justify-center">
                        <User className="w-5 h-5" />
                      </div>
                      <input 
                          type="text" 
                          id="input-name"
                          class="w-full bg-white dark:bg-white/10 border border-black/10 dark:border-white/10 rounded-xl px-10 py-3 focus:outline-none focus:border-primary transition-colors text-foreground dark:text-white"
                          placeholder={t['checkout.placeholder.fullname']}
                      />
                  </div>
              </div>
              <div>
                  <label class="block text-sm font-medium mb-1.5">{t['checkout.label.email']}</label>
                  <div class="relative">
                      <div class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground flex items-center justify-center font-bold">@</div>
                      <input 
                          type="email" 
                          id="input-email"
                          class="w-full bg-white dark:bg-white/10 border border-black/10 dark:border-white/10 rounded-xl px-10 py-3 focus:outline-none focus:border-primary transition-colors text-foreground dark:text-white"
                          placeholder={t['checkout.placeholder.email']}
                      />
                  </div>
              </div>
              <button 
                  id="btn-step-1"
                  class="w-full bg-primary text-white font-bold py-3 rounded-xl hover:opacity-90 transition-opacity flex items-center justify-center gap-2 mt-4"
              >
                  {t['checkout.btn.continue']} <ArrowRight className="w-4 h-4" />
              </button>
          </div>
        </div>

        {/* Step 2: Payment */}
        <div id="step-2" class="step-content hidden transition-opacity duration-300">
            <h2 class="text-2xl font-bold font-display mb-2">{t['checkout.payment.title']}</h2>
            <p class="text-muted-foreground mb-6">{t['checkout.payment.subtitle']}</p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1.5">{t['checkout.label.card']}</label>
                    <div class="relative">
                        <div class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground flex items-center justify-center">
                             <CreditCard className="w-5 h-5" />
                        </div>
                        <input 
                            type="text" 
                            class="w-full bg-white dark:bg-white/10 border border-black/10 dark:border-white/10 rounded-xl px-10 py-3 focus:outline-none focus:border-primary transition-colors font-mono text-foreground dark:text-white"
                            placeholder={t['checkout.placeholder.card']}
                        />
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                        <div>
                        <label class="block text-sm font-medium mb-1.5">{t['checkout.label.expiry']}</label>
                        <input 
                            type="text" 
                            class="w-full bg-white dark:bg-white/10 border border-black/10 dark:border-white/10 rounded-xl px-4 py-3 focus:outline-none focus:border-primary transition-colors text-center font-mono text-foreground dark:text-white"
                            placeholder={t['checkout.placeholder.expiry']}
                        />
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1.5">{t['checkout.label.cvc']}</label>
                        <div class="relative">
                             <div class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground flex items-center justify-center">
                                <Lock className="w-4 h-4" />
                            </div>
                            <input 
                                type="text" 
                                class="w-full bg-white dark:bg-white/10 border border-black/10 dark:border-white/10 rounded-xl px-10 py-3 focus:outline-none focus:border-primary transition-colors font-mono text-foreground dark:text-white"
                                placeholder={t['checkout.placeholder.cvc']}
                            />
                        </div>
                    </div>
                </div>
                
                <button 
                    id="btn-step-2"
                    class="w-full bg-primary text-white font-bold py-3 rounded-xl hover:opacity-90 transition-opacity flex items-center justify-center gap-2 mt-4 disabled:opacity-50"
                >
                    <span class="normal-state flex items-center gap-2">
                        {t['checkout.btn.complete']} {planDisplay && `â€¢ ${planDisplay}`}
                    </span>
                    <span class="loading-state hidden">
                         <Loader2 className="w-5 h-5 animate-spin" />
                    </span>
                </button>
            </div>
        </div>

        {/* Step 3: Success */}
        <div id="step-3" class="step-content hidden text-center py-8 transition-all duration-500 ease-out transform scale-95 opacity-0">
            <div class="w-20 h-20 bg-green-500/20 text-green-500 rounded-full flex items-center justify-center mx-auto mb-6">
                 <Check className="w-10 h-10" />
            </div>
            <h2 class="text-3xl font-bold font-display mb-2">{t['checkout.success.title']}</h2>
            <p class="text-muted-foreground mb-8">
                {t['checkout.success.subtitle'].replace('{plan}', planDisplay || t['checkout.success.default_plan'])}
            </p>
            
            <a href={`/${lang}`} class="inline-flex items-center text-primary font-medium hover:underline">
                {t['checkout.success.btn']} <ArrowRight className="w-4 h-4 ml-2" />
            </a>
        </div>

      </div>
      
      <p class="text-center text-xs text-muted-foreground mt-8 flex items-center justify-center gap-2">
          <Lock className="w-3 h-3" /> {t['checkout.security.text']}
      </p>
    </div>
  </div>
</Layout>

<script>
    // Vanilla JS Logic
    let currentStep = 1;

    function updateSteps() {
        // Update Indicators
        const indicators = document.querySelectorAll('.step-indicator');
        indicators.forEach((ind: any) => {
            const stepNum = parseInt(ind.dataset.step);
            const circle = ind.querySelector('.step-circle');
            const label = ind.querySelector('.step-label');

            if (currentStep >= stepNum) {
                circle.classList.remove('bg-background', 'border-black/10', 'dark:border-white/10', 'text-muted-foreground');
                circle.classList.add('bg-primary', 'border-primary', 'text-white');
                
                label.classList.remove('text-muted-foreground');
                label.classList.add('text-primary');

                // Add Check icon if step is completed (strictly less than current)
                if (currentStep > stepNum) {
                     circle.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><polyline points="20 6 9 17 4 12"></polyline></svg>';
                } else {
                     circle.textContent = stepNum.toString();
                }

            } else {
                 // Reset
                circle.classList.add('bg-background', 'border-black/10', 'dark:border-white/10', 'text-muted-foreground');
                circle.classList.remove('bg-primary', 'border-primary', 'text-white');
                label.classList.add('text-muted-foreground');
                label.classList.remove('text-primary');
                circle.textContent = stepNum.toString();
            }
        });

        // Show/Hide Content
        document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
        const activeStep = document.getElementById(`step-${currentStep}`);
        if(activeStep) {
            activeStep.classList.remove('hidden');
            if (currentStep === 3) {
                 // Trigger animation for success step
                 setTimeout(() => {
                    activeStep.classList.remove('scale-95', 'opacity-0');
                    activeStep.classList.add('scale-100', 'opacity-100');
                 }, 50);
            }
        }
    }

    // Event Listeners
    document.getElementById('btn-step-1')?.addEventListener('click', () => {
        const nameInput = document.getElementById('input-name') as HTMLInputElement;
        const emailInput = document.getElementById('input-email') as HTMLInputElement;

        if (!nameInput.value || !emailInput.value) {
            alert('Please fill in all fields'); // Simple validation
            return;
        }
        currentStep = 2;
        updateSteps();
    });

    document.getElementById('btn-step-2')?.addEventListener('click', () => {
        const btn = document.getElementById('btn-step-2');
        const normalState = btn?.querySelector('.normal-state');
        const loadingState = btn?.querySelector('.loading-state');
        
        if(btn) (btn as HTMLButtonElement).disabled = true;
        normalState?.classList.add('hidden');
        loadingState?.classList.remove('hidden');

        // Simulate API call
        setTimeout(() => {
             currentStep = 3;
             updateSteps();
        }, 1500);
    });

    // Initialize
    updateSteps();

</script>
