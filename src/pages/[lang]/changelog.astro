---
import Layout from '~/layouts/Layout.astro';
import { getCollection, render } from 'astro:content';
import ChangelogItem from '~/components/blog/ChangelogItem.astro';
import PageHeader from '~/components/layout/PageHeader.astro';
import CTA from '~/components/sections/CTA.astro';
import Section from '~/components/layout/Section.astro';
import Container from '~/components/ui/Container.astro';
import { languages } from '~/i18n/ui';
import { useTranslations } from '~/i18n/utils';

export async function getStaticPaths() {
  return Object.keys(languages).map((lang) => ({ params: { lang } }));
}

const { lang } = Astro.params;
const t = useTranslations(lang);

const entries = (await getCollection('changelog'))
    .filter((entry) => entry.id.startsWith(`${lang}/`))
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
---

<Layout 
    title={`${t['nav.changelog']} - Cooper`} 
    description={t['changelog.hero.subtitle']}
>
    <PageHeader 
        title={`${t['changelog.hero.title']} <span class="text-primary">${t['changelog.hero.highlight']}</span>`}
        description={t['changelog.hero.subtitle']}
    />

    <Section class="pt-12 pb-24">
        <Container class="max-w-4xl">

            <div class="relative">
                {entries.map(async (entry) => {
                    const { Content } = await render(entry);
                    return (
                        <ChangelogItem 
                            version={entry.data.version}
                            title={entry.data.title}
                            pubDate={entry.data.pubDate}
                            type={entry.data.type}
                            isSecurity={entry.data.isSecurity}
                            detailsUrl={entry.data.detailsUrl}
                            migrationUrl={entry.data.migrationUrl}
                            body={entry.body}
                            lang={lang}
                        >
                            <Content />
                        </ChangelogItem>
                    )
                })}
            </div>

            <CTA 
                variant="boxed"
                title={t['changelog.updated.title']}
                description={t['changelog.updated.description']}
                primaryBtn={{ text: t['changelog.updated.follow'], href: 'https://linkedin.com/company/gladtek' }}
                secondaryBtn={{ text: t['changelog.updated.newsletter'], href: 'https://linkedin.com/company/gladtek' }}
            />
        </Container>
    </Section>
</Layout>
